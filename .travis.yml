# https://docs.travis-ci.com/user/job-lifecycle
sudo: false
language: node_js
node_js:
  - '12'
services:
  - docker
git:
  depth: false
branches:
  only:
    - gh-pages
    - /.*/
cache: npm
install:
  - npm install
after_script:
  - npm run coveralls
  - docker build -t bierteam/pils:$TRAVIS_BRANCH .
  - docker push bierteam/pils
before_deploy:
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
  - openssl aes-256-cbc -K $encrypted_0394b0a27270_key -iv $encrypted_0394b0a27270_iv
    -in deploy_key.enc -out /tmp/deploy_key -d
  - eval "$(ssh-agent -s)"
  - chmod 600 /tmp/deploy_key
  - ssh-add /tmp/deploy_key
  - cp config/backend.example.js config/backend.js
  - npm run build
deploy:
  - provider: script
    skip_cleanup: true
    script: ssh -o StrictHostKeyChecking=no -p$DEV_PORT root@$DEV_SERVER 'cd Pils/; git stash; git checkout dev; git pull; npm ci --only=production; npm i -g pm2; pm2 update; npm restart;' && rsync -rvz --delete -e "ssh -p $DEV_PORT" public/ root@$DEV_SERVER:~/Pils/public
    on:
      branch: dev
  - provider: script
    skip_cleanup: true
    script: ssh -o StrictHostKeyChecking=no -p$PRODUCTION_PORT root@$PRODUCTION_SERVER 'cd Pils/; git stash; git checkout master; git pull; npm ci --only=production; npm i -g pm2; pm2 update; npm restart;' && rsync -rvz --delete -e "ssh -p $PRODUCTION_PORT" public/ root@$PRODUCTION_SERVER:~/Pils/public
    on:
      branch: master
